---
title: "Trucking_mini_Model"
output: html_document
date: "2025-11-24"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = 'RDO_Trucking') #This sets the working
library(readr, quietly = TRUE) # We import this library so that we can read in things from csv files.
library(ompr)
library(ompr.roi)
library(ROI.plugin.glpk)
library(magrittr)
library(dplyr)
library(tidyr)
library(tibble)
```

```{r}
drivers_csv <- read_csv("Drivers.csv")
drivers_id <- drivers_csv$DriverID
drivers_maxnight <- drivers_csv$MaxNightsOvernightPerWeek
num_drivers <- length(drivers_id)
names(drivers_maxnight) <- drivers_id
max_load <- drivers_csv$`Max Load Pounds`
names(max_load) <- drivers_id
drivers_location <- setNames(
    paste(drivers_csv$Location, drivers_csv$State, sep = ", "),
    drivers_csv$DriverID
)
drivers_payrate <- drivers_csv$`Hourly Wage`
names(drivers_payrate) <- drivers_id

drivers_id
drivers_maxnight
max_load
drivers_location
drivers_payrate
```

```{r}
locations_csv <- read_csv("Locations.csv")
locations <- paste(locations_csv$City, locations_csv$State, sep = ", ")
locations
```

```{r}
mileage_csv <- read_csv("MileageMatrix.csv")
locations <- mileage_csv$Origination
mileage <- as.matrix(mileage_csv[,-1]) # everything except the first column
rownames(mileage) <- locations
mileage[is.na(mileage)] <- 0
# 1. Remove extra spaces around commas
colnames(mileage) <- gsub("\\s*,\\s*", ", ", colnames(mileage))

# 2. Trim leading/trailing whitespace just in case
colnames(mileage) <- trimws(colnames(mileage))

mileage

# 1. compute travel time in minutes (distance / speed * 60)
travel_minutes <- mileage / 50 * 60   # 50 mph

# 2. convert minutes â†’ 60-min (1-hour) time steps (ceil)
DriveTime <- ceiling(travel_minutes / 60)

DriveTime
```

```{r}
workorders_csv <- read_csv("TruckingWorkorders.csv")
workorders_id <- as.character(workorders_csv$WorkOrderNumber)

# Origin
w_order_start <- setNames(workorders_csv$Origination, workorders_id)
# Destination
w_order_end <- setNames(workorders_csv$Destination, workorders_id)

# Weight
w_order_weight <- setNames(workorders_csv$LoadWeight, workorders_id)

# Days due
w_order_due <- setNames(workorders_csv$DeliveryDays, workorders_id)

w_order_start


```

```{r}
time_step_mins <- 60  # 15 minutes was too slow
total_minutes <- 7 * 24 * 60  # 10080
T_seq <- seq(0, total_minutes - time_step_mins, by = time_step_mins)
length(T_seq)  # now 168 instead of 672
```


## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
AvgSpeed <- 50
Cost_Of_Fuel <- 0.4
M_big <- 1e6
T_seq         <- 1:4              # T, minutes
Days          <- 1:2

# Map days -> time indices
T_day <- lapply(Days, function(day) T_seq)
names(T_day) <- as.character(Days)

# -----------------------------
# --- MODEL
# -----------------------------
model <- MIPModel() %>%
  # -----------------------------
  # --- DECISION VARIABLES
  # -----------------------------
  add_variable(routed[d,i,j,t,w], d=drivers_id, i=locations, j=locations, t=T_seq, w=workorders_id, type="binary") %>%  # Routed
  add_variable(atnode[w,i,t], w=workorders_id, i=locations, t=T_seq, type="binary") %>%  # AtNode
  add_variable(delivered[w], w=workorders_id, type="binary") %>%  # Delivered
  add_variable(sleepon[d,day], d=drivers_id, day=Days, type="binary") %>%  # SleepON
  add_variable(didwork[d,day], d=drivers_id, day=Days, type="binary") %>%  # DidWork
  add_variable(driverhours_day[d,day], d=drivers_id, day=Days, type="continuous", lb=0) %>%  # daily hours
  add_variable(driverhours_total[d], d=drivers_id, type="continuous", lb=0) %>%  # weekly hours
  add_variable(overtime_hours[d], d=drivers_id, type="continuous", lb=0) %>%  # Overtime
  add_variable(drivermiles[d], d=drivers_id, type="continuous", lb=0) %>%  # Total miles
  add_variable(overnight_cost, type="continuous", lb=0) %>%  # cost variables
  add_variable(fuel_cost, type="continuous", lb=0) %>%
  add_variable(pay_cost, type="continuous", lb=0)

# -----------------------------
# --- CONSTRAINTS
# -----------------------------

# --- 1) Flow: Initial locations (All workorders at their origin at t0)
for (w in workorders_id) {
  model <- model %>% add_constraint(atnode[w, w_order_start[w], 1] == 1)
  for (i in setdiff(locations, w_order_start[w])) {
    model <- model %>% add_constraint(atnode[w, i, 1] == 0)
  }
}

# --- 2) At most one node per workorder at each time
model <- model %>% add_constraint(sum_over(atnode[w,i,t], i=locations) == 1, w=workorders_id, t=T_seq)

# --- 3) Prevent moving workorder from where it isn't
model <- model %>% add_constraint(sum_over(routed[d,i,j,t,w], j=locations) <= atnode[w,i,t],
                                  d=drivers_id, i=locations, t=T_seq, w=workorders_id)

# --- 4) Flow between nodes
model <- model %>% add_constraint(
  atnode[w,i,t+1] ==
    atnode[w,i,t] +
    sum_expr(routed[d,k,i,t,w], d=drivers_id, k=locations) -
    sum_expr(routed[d,i,j,t,w], d=drivers_id, j=locations),
  w=workorders_id,
  i=locations,
  t=T_seq[T_seq < max(T_seq)]
)

# --- 5) Delivered definition
model <- model %>% add_constraint(delivered[w] <= sum_over(atnode[w, w_order_end[w], t], t=T_seq), w=workorders_id)

# --- 6) On-time delivery
for (w in workorders_id) {
  valid_T <- T_seq[T_seq <= w_order_due[w]*2]  # 2 time steps per day
  model <- model %>% add_constraint(sum_over(atnode[w, w_order_end[w], t], t=valid_T) >= 1)
}

# --- 7) Load capacity (truck max)
model <- model %>% add_constraint(sum_over(w_order_weight[w] * routed[d,i,j,t,w], w=workorders_id) <= max_load[d],
                                  d=drivers_id, i=locations, j=locations, t=T_seq)

# --- 8) Driver hours per day
for (day in Days) {
  tvec <- T_day[[as.character(day)]]
  model <- model %>% add_constraint(driverhours_day[d,day] ==
                                      sum_over(routed[d,i,j,t,w]*(mileage[i,j]/AvgSpeed), i=locations, j=locations, t=tvec, w=workorders_id),
                                    d=drivers_id)
}

# --- 9) Mandatory delivery
model <- model %>% add_constraint(delivered[w] == 1, w = workorders_id)

# --- 10) Max hours per day
IsSat <- setNames(ifelse(Days==2,1,0), Days)
IsWorkday <- setNames(1 - IsSat, Days)
model <- model %>% add_constraint(driverhours_day[d,day] <= 14*IsWorkday[day] + 4*IsSat[day],
                                  d=drivers_id, day=Days)

# --- 11) DidWork big-M
model <- model %>% add_constraint(sum_over(routed[d,i,j,t,w], i=locations, j=locations, t=T_seq, w=workorders_id) <= M_big*didwork[d,day],
                                  d=drivers_id, day=Days)

# --- 12) Max overnights
model <- model %>% add_constraint(sum_over(sleepon[d,day], day=Days) <= drivers_maxnight[d], d=drivers_id)

# --- 13) Total & Overtime hours
model <- model %>% add_constraint(driverhours_total[d] == sum_over(driverhours_day[d,day], day=Days), d=drivers_id)
model <- model %>% add_constraint(overtime_hours[d] >= driverhours_total[d]-40, d=drivers_id)
model <- model %>% add_constraint(overtime_hours[d] >= 0, d=drivers_id)

# --- 14) Total miles
model <- model %>% add_constraint(drivermiles[d] == sum_over(routed[d,i,j,t,w]*mileage[i,j], i=locations, j=locations, t=T_seq, w=workorders_id), d=drivers_id)

# --- 15) Cost definitions
model <- model %>%
  add_constraint(overnight_cost == sum_expr(175*sleepon[d,day], d=drivers_id, day=Days)) %>%
  add_constraint(fuel_cost      == sum_expr(routed[d,i,j,t,w]*mileage[i,j]*Cost_Of_Fuel,
                                           d=drivers_id, i=locations, j=locations, t=T_seq, w=workorders_id)) %>%
  add_constraint(pay_cost       == sum_expr(drivers_payrate[d]*(driverhours_total[d]+0.5*overtime_hours[d]), d=drivers_id))

# -----------------------------
# --- OBJECTIVE
# -----------------------------
model <- model %>% set_objective(overnight_cost + fuel_cost + pay_cost, sense="min")

# -----------------------------
# --- SOLVE
# -----------------------------
sol <- solve_model(model, with_ROI(solver="glpk", verbose=TRUE))

cat("Status:", sol$status, "\n")
if (sol$status %in% c("optimal","feasible")) {
  print(sol %>% get_solution(drivermiles[d]))
  print(sol %>% get_solution(driverhours_total[d]))
  print(sol %>% get_solution(overtime_hours[d]))
  print(sol %>% get_solution(delivered[w]))
  
  
}

 print(sol %>% get_solution(drivermiles[d]))
  print(sol %>% get_solution(driverhours_total[d]))
  print(sol %>% get_solution(overtime_hours[d]))
  print(sol %>% get_solution(delivered[w]))

```


